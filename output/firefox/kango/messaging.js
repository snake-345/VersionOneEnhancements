function MessageSource(){this.dispatchMessage=function(e,s){}}function MessageRouterBase(){this._messageQueue=[]}var core=require("kango/core"),utils=require("kango/utils"),timer=require("kango/timer"),backgroundScriptEngine=require("kango/backgroundscript_engine"),array=utils.array,func=utils.func;MessageRouterBase.prototype={_dispatchMessagesFromQueue:function(){this._messageQueue.length>0&&(backgroundScriptEngine.isLoaded()?(array.forEach(this._messageQueue,function(e){core.fireEvent(e.name,e.event)}),this._messageQueue=[]):timer.setTimeout(func.bind(function(){this._dispatchMessagesFromQueue()},this),100))},fireMessageEvent:function(e,s){backgroundScriptEngine.isLoaded()?(this._dispatchMessagesFromQueue(),core.fireEvent("message",s)):(this._messageQueue.push({name:e,event:s}),timer.setTimeout(func.bind(function(){this._dispatchMessagesFromQueue()},this),100))},dispatchMessage:function(e,s){var i={name:e,data:s,origin:"background",target:this,source:this};return this.dispatchMessageEx(i)},dispatchMessageEx:function(e){return timer.setTimeout(func.bind(function(){this.fireMessageEvent("message",e)},this),1),!0}};







function MessageRouter(){MessageRouterBase.apply(this,arguments),this._messageName=io.getResourceUrl("message"),this._unloadMessageName=io.getResourceUrl("message-unload"),this._listener=func.bind(this._onMessage,this),this._contentScriptUrl=io.getExtensionFileUrl("includes/content_loader.js")+"?"+Math.random(),this._globalMessageManager=Cc["@mozilla.org/globalmessagemanager;1"].getService(Ci.nsIMessageListenerManager),this._globalMessageManager.addMessageListener(this._messageName,this._listener),this._globalMessageManager.loadFrameScript(this._contentScriptUrl,!0)}var utils=require("kango/utils"),io=require("kango/io"),extensionInfo=require("kango/extension_info"),browser=require("kango/browser"),object=utils.object,func=utils.func;MessageRouter.prototype=object.extend(MessageRouterBase,{_onMessage:function(e){var s={name:e.data.name,data:e.data.data,origin:e.data.origin};if("tab"==s.origin&&e.target.messageManager){var a=browser.getTabFromBrowser(e.target);if(a)s.source=s.target=browser.getTab(a);else{var t=this._messageName;s.source=s.target={dispatchMessage:function(s,a){var r={name:s,data:null!=a?object.sanitize(a):a,origin:"background"};e.target.messageManager.sendAsyncMessage(t,r)}}}}this.fireMessageEvent("message",s)},broadcastMessage:function(e,s){var a={name:e,data:null!=s?object.sanitize(s):s,origin:"background"};this._globalMessageManager.broadcastAsyncMessage(this.getMessageName(),a)},getMessageName:function(){return this._messageName},dispose:function(){this._globalMessageManager.removeDelayedFrameScript(this._contentScriptUrl),this._globalMessageManager.removeMessageListener(this._messageName,this._listener),this._globalMessageManager.broadcastAsyncMessage(this._unloadMessageName)}}),module.exports=new MessageRouter;